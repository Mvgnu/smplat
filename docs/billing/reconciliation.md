# Billing Reconciliation Operations

This document outlines the workflow for ingesting Stripe statements, processing reconciliation runs, and responding to discrepancies generated by the billing worker.

## Statement Ingestion

- The `StripeStatementIngestionService` pulls Stripe balance transactions for the prior seven days and persists them to `processor_statements`.
- Transactions are matched to invoices through the Stripe charge metadata (`invoice_id`, `workspace_id`) and stored with normalized gross, fee, and net amounts.
- Transactions without a resolvable workspace are skipped to prevent orphaned records. When possible, unmatched transactions create discrepancies during reconciliation.

## Reconciliation Runs

- The `BillingLedgerReconciliationWorker` triggers statement ingestion and dispute syncs on each sweep.
- A reconciliation run is opened (or reused if already running) for every sweep and updated with totals, matches, and discrepancy counts.
- The helper `reconcile_statements` evaluates persisted statements, incrementing `matched_transactions` for invoices with successful linkage and logging discrepancies when invoices are missing.

## Dispute Automation

- Stripe disputes are fetched during every worker run. Each dispute is recorded as an `UNAPPLIED_REFUND` discrepancy tied to the open reconciliation run.
- Operators can track dispute identifiers, statuses, and deltas in the dashboard and via the API endpoints documented below.

## API Endpoints

- `GET /api/v1/billing/reconciliation/runs`: Lists recent reconciliation runs alongside open discrepancies.
- `GET /api/v1/billing/reconciliation/discrepancies`: Returns discrepancies filtered by status.
- `POST /api/v1/billing/reconciliation/discrepancies/{id}/acknowledge`: Marks a discrepancy as acknowledged.
- `POST /api/v1/billing/reconciliation/discrepancies/{id}/resolve`: Resolves a discrepancy and records resolution notes.
- `POST /api/v1/billing/reconciliation/discrepancies/{id}/requeue`: Reopens a discrepancy for further investigation.
- `GET /api/v1/billing/reconciliation/statements`: Returns discrepancies linked to processor statements for focused review.

## Run Cadence & SLAs

- **Cadence:** Execute the reconciliation worker hourly in production to ensure timely detection of variances.
- **Dispute SLA:** Finance should acknowledge disputes within 24 hours and resolve within Stripe's dispute window.
- **Rollback:** To revert a faulty ingestion, delete the affected `processor_statements` rows and rerun the worker; discrepancies will be recalculated on the next sweep.

## Alerting & Monitoring

- Track `statements_ingested` and `disputes_logged` metrics emitted by the worker to ensure ingestion health.
- Investigate spikes in `MISSING_INVOICE` discrepancies, which may indicate missing metadata from Stripe charges.
- Use the dashboard reconciliation panel to review open items and confirm resolution flows.
